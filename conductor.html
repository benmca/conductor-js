<!DOCTYPE html>

<html>
<head>
    <title>Conductor</title>
    <script id="defaultScore" type="text/json">
{
  "title" : "Example Score",
  "tempo" : 60.0,
  "tempoEnv" : [ 1, 60.0, 6, 90.0 ],
  "groups" : [
    { "label" : "opening",
      "count" : 3,
      "tempo" : 60.0,
      "numerator" : 7,
      "denominator" : 8,
      "accents" : [ 3, 1, 1, 2, 1, 2, 1 ]
    },
    { "label" : "accented",
      "count" : 3,
      "tempo" : 60.0,
      "numerator" : 7,
      "denominator" : 8,
      "groups" : [ 3, 2, 2 ]
    },
    { "label" : "freetime",
      "duration": 20.0 },
    { "label" : "closing",
      "count" : 3,
      "tempo" : 90.0,
      "numerator" : 4,
      "denominator" : 4 } ]
}


    </script>
    <script id="mandalas" type="text/json">
{
  "title" : "Mandalas",
  "tempo" : 50.0,
  "marks" : [
    { "mark" : "Top", "bar" : 1 },
    { "mark" : "A", "bar" : 40 },
    { "mark" : "B", "bar" : 61 },
    { "mark" : "C", "bar" : 100 }
  ],
  "groups" : [
    { "label" : "w/ pick",
      "accents" : [ 3, 0, 0, 0 ],
      "count" : 39,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "w/ ebow",
      "count" : 81,
      "numerator" : 4,
      "denominator" : 4 }
  ]
}


    </script>
    <script id="mandala5" type="text/json">
{
  "title" : "Mandala 5",
  "tempo" : 60.0,
  "marks" : [
    { "mark" : "A", "bar" : 1 },
    { "mark" : "B", "bar" : 2 },
    { "mark" : "C", "bar" : 3 },
    { "mark" : "D", "bar" : 4 },
    { "mark" : "E", "bar" : 5 },
    { "mark" : "F", "bar" : 6 },
    { "mark" : "G", "bar" : 7 },
    { "mark" : "H", "bar" : 8 },
    { "mark" : "I", "bar" : 9 },
    { "mark" : "I", "bar" : 10 }
  ],
  "groups" : [
    { "label" : "Bar 1",
      "duration": 60.0 },
    { "label" : "Bar 2",
      "duration": 60.0 },
    { "label" : "Bar 3",
      "duration": 60.0 },
    { "label" : "Bar 4",
      "duration": 60.0 },
    { "label" : "Bar 5",
      "duration": 60.0 },
    { "label" : "Bar 6",
      "duration": 60.0 },
    { "label" : "Bar 7",
      "duration": 60.0 },
    { "label" : "Bar 8",
      "duration": 60.0 },
    { "label" : "Bar 9",
      "duration": 60.0 },
    { "label" : "Bar 10",
      "duration": 60.0 }
  ]
}


    </script>
    <script id="askance" type="text/json">
{
  "title" : "Askance",
  "tempo" : 88.0,
  "marks" : [
    { "mark" : "Top", "bar" : 1 },
    { "mark" : "A", "bar" : 21 },
    { "mark" : "B", "bar" : 29 },
    { "mark" : "C", "bar" : 49 },
    { "mark" : "D", "bar" : 57 }
  ],
  "groups" : [
    { "label" : "",
      "count" : 20,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 8,
      "numerator" : 6,
      "denominator" : 4 },
    { "label" : "",
      "count" : 20,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 18,
      "numerator" : 6,
      "denominator" : 4 }
  ]
}


    </script>
    <script id="andriessen" type="text/json">
{
  "title" : "After Andreissen",
  "tempo" : 54.0,
  "tempoEnv" : [ 46, 54.0, 67, 120.0 ],
  "marks" : [
    { "mark" : "A", "bar" : 1 },
    { "mark" : "B", "bar" : 46 },
    { "mark" : "C", "bar" : 67 },
    { "mark" : "D", "bar" : 85 },
    { "mark" : "E", "bar" : 103 }
  ],
  "groups" : [
    { "label" : "",
      "count" : 45,
      "numerator" : 3,
      "denominator" : 4 },
    { "label" : "accelerando",
      "count" : 21,
      "numerator" : 3,
      "denominator" : 4 },
    { "label" : "first repeat",
      "count" : 18,
      "numerator" : 3,
      "denominator" : 4 },
    { "label" : "second repeat",
      "count" : 18,
      "numerator" : 3,
      "denominator" : 4 },
    { "label" : "",
      "count" : 24,
      "numerator" : 3,
      "denominator" : 4 }
  ]
}


    </script>
    <script id="theRock" type="text/json">
{
  "title" : "The Rock",
  "tempo" : 120.0,
  "groups" : [
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 6,
      "numerator" : 4,
      "denominator" : 4 },
    { "label" : "",
      "count" : 1,
      "numerator" : 5,
      "denominator" : 4 },
    { "label" : "",
      "count" : 14,
      "numerator" : 4,
      "denominator" : 4 }
  ]
}


    </script>
    <script id="skips" type="text/json">
{
  "title" : "Skips",
  "tempo" : 92.0,
  "marks" : [
    { "mark" : "Top", "bar" : 1 }
  ],
  "groups" : [
    { "label" : "",
      "count" : 86,
      "numerator" : 4,
      "denominator" : 4 }
  ]
}


    </script>
    <script>
        var canvas, ctx, timer, now, before, delta, elapsed, interval, app, obj, totalElapsed;
        var meter, num, ang, angle, angleIncr, alphaBlue, alphaRed, click, subdiv;
        var tempoIncr, changeTempo, tempoBar1, tempoBar2, tempoDoesChange;
        /* display */
        var title, barLabel;
        /* geometry */
        var cx, cy, nx, ny, outerRad, innerRad, pntrRad, border, textSize, textAngle, angleDiff;
        /* operation */
        var score, measure, bar, beat, tempo, tempoScaler, numBars, numBeats, running, app;
        var scoreTempo, loopIn, loopOut, loop, countIn, countInBar;

        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(id) {
            if (id > 0) {
                var freqs = [330.0, 660.0, 990.0, 1320.0];
                var osc = audioCtx.createOscillator();
                var env = audioCtx.createGain();
                var now = audioCtx.currentTime;

                osc.frequency.value = freqs[id];
                env.gain.setValueAtTime(1.0, now);
//env.gain.value = 1.0;
                env.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
                osc.connect(env);
                env.connect(audioCtx.destination);

                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        obj = JSON.parse(document.getElementById("defaultScore").innerHTML);

        function loadScore(scoreID) {
            obj = JSON.parse(document.getElementById(scoreID).innerHTML);
            makeScore();
            numBars = score.length;
            tempoScaler = tempo / scoreTempo;
            bar = 0;
            measure = score[bar];
            if (measure.type == 0) {
                countIn = 1;
                countInBars = 2;
            }
            updateMeasure();
            loopIn = 0;
            loopOut = numBars - 1;
            draw();
            document.getElementById("display").innerHTML = document.getElementById(scoreID).innerHTML;
        }

        function makeScore() {
            var g;
            score = [];
            title = obj['title'];
            scoreTempo = obj['tempo'];
            tempo = scoreTempo;
            var marks, cnt;
            if ('marks' in obj) {
                marks = obj['marks'];
            }
            else {
                marks = [{"mark": "None", "bar": 1}];
            }
            var select = document.getElementById("select");
            select.options.length = 0;
            for (var i = 0; i < marks.length; i++) {
                var opt = marks[i];
                var el = document.createElement("option");
                el.textContent = opt['mark'];
                el.value = opt['bar'];
                select.appendChild(el);
            }

            var groups = obj['groups'];
            var numGroups = groups.length;
            for (g = 0; g < numGroups; g++) {
                if ('duration' in groups[g]) {
                    var mlabel = groups[g]['label'];
                    var dur = groups[g]['duration'];
                    score.push(
                        {
                            type: 1,
                            tempo: 0.0,
                            numerator: 0,
                            denominator: 0,
                            beat_dur: dur,
                            label: mlabel
                        }
                    )
                }
                else {
                    var fast, i;
                    var cnt = groups[g]['count'];
                    var numer = groups[g]['numerator'];
                    var denom = groups[g]['denominator'];
                    var mlabel = groups[g]['label'];
                    if ('tempo' in groups[g]) fast = groups[g]['tempo']; else fast = scoreTempo;
                    var has_groups = 0;
                    if ('groups' in groups[g]) {
                        has_groups = 1;
                        var old_groups = groups[g]['groups'];
                        var new_groups = [0];
                        for (i = 1; i < old_groups.length; i++) {
                            new_groups.push(old_groups[i - 1] + new_groups[i - 1]);
                        }
                    }
                    var stresses = [];
                    if ('accents' in groups[g]) {
                        for (i = 0; i < numer; i++) stresses.push(groups[g]['accents'][i]);
                    }
                    else {
                        stresses.push(3);
                        for (i = 1; i < numer; i++) stresses.push(2);
                    }
                    for (i = 0; i < cnt; i++) {
                        if (has_groups == 1) {
                            score.push({
                                type: 0,
                                tempo: fast,
                                numerator: numer,
                                denominator: denom,
                                beat_dur: 4.0 / denom,
                                label: mlabel,
                                groups: new_groups,
                                accents: stresses
                            })
                        }
                        else {
                            score.push(
                                {
                                    type: 0,
                                    tempo: fast,
                                    numerator: numer,
                                    denominator: denom,
                                    beat_dur: 4.0 / denom,
                                    label: mlabel,
                                    accents: stresses
                                }
                            )
                        }
                    }
                }
            }
            var accelDur = 0.0;
            if ('tempoEnv' in obj) {
                tempoDoesChange = 1;
                tempo_arr = obj['tempoEnv'];
                for (i = tempo_arr[0] - 1; i < tempo_arr[2] - 1; i++) {
                    accelDur += score[i].numerator * score[i].beat_dur * (60.0 / score[i].tempo);
                }
                var tempoAve = ((tempo_arr[3] - tempo_arr[1]) / 120.0) + 1.0;
                accelDur /= tempoAve;
                tempoIncr = (tempo_arr[3] - tempo_arr[1]) / accelDur;
                tempoBar1 = tempo_arr[0] - 1;
                tempoBar2 = tempo_arr[2] - 1;
                if (tempoBar1 == 0) changeTempo = 1;
            }
            else {
                tempoDoesChange = 0;
                tempoIncr = 0.0;
            }
        }

        function backingScale() {
            if ('devicePixelRatio' in window) {
                if (window.devicePixelRatio > 1) {
                    return window.devicePixelRatio;
                }
            }
            return 1;
        }

        function init() {
            var scaleFactor = backingScale();
            canvas = document.getElementById("myCanvas");
            canvas.width = window.innerWidth * 0.75;
            canvas.height = canvas.width * 0.6;
//canvas.height = window.innerHeight*0.8;
//canvas.width = canvas.height*1.6;
            if (scaleFactor > 1) {
//canvas.width = can.width * scaleFactor;
//canvas.height = can.height * scaleFactor;
            }
            ctx = canvas.getContext("2d");
            document.getElementById("display").innerHTML = document.getElementById("defaultScore").innerHTML;

            cx = canvas.height / 2;
            cy = canvas.height / 2;
            border = canvas.height;
            outerRad = (canvas.height / 2) * 0.95;
            innerRad = (canvas.height / 2) * 0.85;
            pntrRad = (canvas.height / 2) * 0.75;
            textSize = (canvas.height / 2) * 0.125;
            makeScore();
            numBars = score.length;
            tempoScaler = tempo / scoreTempo;

            bar = 0;
            measure = score[bar];
            if (measure.type == 0) {
                countIn = 1;
                countInBars = 2;
            }
            updateMeasure();
            alphaRed = 0.0;
            alphaBlue = 0.0;

            ctx.font = textSize + "px arial";
            changeTempo = 0;
            click = 0;
            subdiv = 1;
            app = 0;
            running = 0;
            loop = 0;
            loopIn = 0;
            loopOut = numBars - 1;
            elapsed = 0.0;
            date = new Date();
            before = date.getTime();
//timer = setInterval(update, 10);
//tempoIncr = (120 - 60)/30.0;
//document.getElementById("display").innerHTML = tempoIncr.toString();
            draw();
        }

        function draw() {
            var n;
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = "white";
            ctx.lineWidth = 3.0;
            ctx.beginPath();
            ctx.arc(cx, cy, outerRad, 0, 2 * Math.PI);
            ctx.stroke();

            if (measure.type == 0) {
                textAngle = -1.5707963267949;
                angleDiff = 2.0 * Math.PI / measure.numerator;
                for (n = 0; n < measure.numerator; n++) {
                    nx = innerRad * Math.cos(textAngle);
                    ny = innerRad * Math.sin(textAngle);
                    ctx.textBaseline = "middle";
                    ctx.textAlign = "center";
                    ctx.fillStyle = "white";
                    if ('groups' in measure) {
                        var test = measure['groups'].indexOf(n);
                        if (test != -1) ctx.fillText((test + 1).toString(), cx + nx, cy + ny);
                    }
                    else
                        ctx.fillText((n + 1).toString(), cx + nx, cy + ny);
                    textAngle += angleDiff;
                }
            }
            ctx.fillStyle = "white";
            if (measure.type == 0) {
                nx = pntrRad * Math.cos(angle);
                ny = pntrRad * Math.sin(angle);
            }
            else {
                nx = pntrRad * 1.2 * Math.cos(angle);
                ny = pntrRad * 1.2 * Math.sin(angle);
            }
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + nx, cx + ny);
            ctx.strokeStyle = "white";
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(border, 0);
            ctx.lineTo(border, border);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(cx, cy, outerRad, 0, 2 * Math.PI);
            ctx.globalAlpha = alphaBlue;
            ctx.fillStyle = "blue";
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.globalAlpha = 1.0;
            ctx.beginPath();
            ctx.arc(cx, cy, outerRad, 0, 2 * Math.PI);
            ctx.globalAlpha = alphaRed;
            ctx.fillStyle = "red";
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.globalAlpha = 1.0;

            ctx.fillStyle = "white";
            ctx.textBaseline = "top";
            ctx.textAlign = "left";
            ctx.fillText(measure.label, border + 20, 20);
            if (measure.type == 0) {
                ctx.fillText("bpm: " + (measure.tempo * tempoScaler).toFixed(1), border + 20, textSize + 20);
                ctx.fillText("beat: " + (beat + 1).toString(), border + 20, textSize * 2 + 20);
                ctx.fillText("meter: " + measure.numerator.toString() + "/" + measure.denominator.toString(), border + 20, textSize * 3 + 20);
                if (countIn == 1)
                    ctx.fillText("bar: " + (bar + 1).toString() + " of " + numBars.toString() + " (-" + countInBars.toString() + ")", border + 20, textSize * 4 + 20);
                else
                    ctx.fillText("bar: " + (bar + 1).toString() + " of " + numBars.toString(), border + 20, textSize * 4 + 20);
            }
            else {
                ctx.fillText("adjust: " + (tempoScaler * 100).toFixed(2) + "%", border + 20, textSize + 20);
                ctx.fillText("left: " + (interval - elapsed).toFixed(1) + " of " + interval.toFixed(1), border + 20, textSize * 2 + 20);
                ctx.fillText("bar: " + (bar + 1).toString() + " of " + numBars.toString(), border + 20, textSize * 4 + 20);
            }
//ctx.fillText("label: "+testlabel, border+20, textSize*5+20);
            if (loop == 1) ctx.fillText("loop: " + (loopIn + 1).toString() + " to " + (loopOut + 1).toString(), border + 20, textSize * 5 + 20);
            ctx.fillText(title, border + 20, canvas.height - textSize - 20);

        }

        function update() {
            draw();

            date = new Date();
            now = date.getTime();
            delta = (now - before) / 1000.0;
            before = now;
            alphaRed *= 0.9;
            alphaBlue *= 0.9;
            if (running == 1) {
                if (elapsed == 0.0) {
                    if (measure.type == 0) {
                        if (beat == 0) {
                            alphaRed = 1.0;
                            if (click == 1) playSound(measure['accents'][beat]);
                        }
                        else {
                            if ('groups' in measure) {
                                var test = measure['groups'].indexOf(beat);
                                if (test != -1) {
                                    alphaBlue = 1.0;
                                    if (click == 1) playSound(measure['accents'][beat]);
                                }
                                else {
//if(click == 1 && subdiv == 1) playSound(measure['accents'][beat]);
                                }
                            }
                            else {
                                alphaBlue = 1.0;
                                if (click == 1) playSound(measure['accents'][beat]);
                            }
                        }
                    }
                }
                if (changeTempo == 1 && countIn == 0) {
                    tempo += (tempoIncr * delta);
                    updateTempo();
                }
                angle += (angleIncr * delta);
                elapsed += delta;
                if (elapsed >= interval) {
                    if (measure.type == 0) {
                        beat++;
                        if (beat == numBeats) {
                            if (countIn == 1) {
                                countInBars--;
                                if (countInBars == 0) countIn = 0;
                            }
                            else bar++;
                            if (tempoDoesChange == 1) {
                                if (bar == tempoBar1) changeTempo = 1;
                                if (bar == tempoBar2) changeTempo = 0;
                            }
                            if (bar == (loopOut + 1) && loop == 1) bar = loopIn;
                            if (bar == numBars) {
                                stop();
                                alphaRed = 1.0;
                                if (click == 1) playSound(measure['accents'][beat]);
                            }
                            else {
                                measure = score[bar];
                                updateMeasure();
                            }
                        }
                    }
                    else {
                        bar++;
                        if (bar == (loopOut + 1) && loop == 1) bar = loopIn;
                        if (bar == numBars) {
                            stop();
                            alphaRed = 1.0;
                            if (click == 1) playSound(measure['accents'][beat]);
                        }
                        else {
                            measure = score[bar];
                            if (measure.type == 0) {
                                countIn = 1;
                                countInBars = 1;
                            }
                            updateMeasure();
                        }
                    }
                    elapsed = 0.0;
                }
            }
        }

        function start() {
            if (app == 1) {
                if (running == 0) {
                    running = 1;
                    document.getElementById("run").innerHTML = "||";
                }
                else {
                    running = 0;
                    document.getElementById("run").innerHTML = ">";
                }
            }
        }

        function stop() {
            if (app == 1) {
                running = 0;
                if (loop == 1) {
                    bar = loopIn;
                }
                else
                    bar = 0;
                measure = score[bar];
                if (measure.type == 0) {
                    countIn = 1;
                    countInBars = 2;
                }
                elapsed = 0.0;
                tempo = scoreTempo;
                tempoScaler = 1.0;
                updateMeasure();
                document.getElementById("run").innerHTML = ">";
                if (app == 0) draw();
            }
        }

        function increaseTempo() {
            tempo += 1.0;
            tempoScaler = tempo / scoreTempo;
            if (measure.type == 0) {
                angleIncr = (2 * Math.PI) / ((60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur * measure.numerator);
                interval = (60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur;
                angle = (((beat * interval + elapsed) / (interval * measure.numerator)) * 2 * Math.PI) - 1.5707963267949;
            }
            else {
                angleIncr = (2 * Math.PI) / (measure.beat_dur / tempoScaler);
                interval = measure.beat_dur / tempoScaler;
                angle = (elapsed / interval) * 2 * Math.PI - 1.5707963267949;
            }
            if (app == 0) draw();
        }

        function decreaseTempo() {
            tempo -= 1.0;
            tempoScaler = tempo / scoreTempo;
            if (measure.type == 0) {
                angleIncr = (2 * Math.PI) / ((60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur * measure.numerator);
                interval = (60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur;
                angle = (((beat * interval + elapsed) / (interval * measure.numerator)) * 2 * Math.PI) - 1.5707963267949;
            }
            else {
                angleIncr = (2 * Math.PI) / (measure.beat_dur / tempoScaler);
                interval = measure.beat_dur / tempoScaler;
                angle = (elapsed / interval) * 2 * Math.PI - 1.5707963267949;
            }
            if (app == 0) draw();
        }

        function updateTempo() {
            tempoScaler = tempo / scoreTempo;
            if (measure.type == 0) {
                angleIncr = (2 * Math.PI) / ((60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur * measure.numerator);
                interval = (60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur;
                angle = (((beat * interval + elapsed) / (interval * measure.numerator)) * 2 * Math.PI) - 1.5707963267949;
            }
            else {
                angleIncr = (2 * Math.PI) / (measure.beat_dur / tempoScaler);
                interval = measure.beat_dur / tempoScaler;
                angle = (elapsed / interval) * 2 * Math.PI - 1.5707963267949;
            }
        }

        function increaseBar() {
            bar++;
            if (bar >= numBars) bar -= numBars;
            measure = score[bar];
            updateMeasure();
            if (running == 0 && measure.type == 0) {
                countIn = 1;
                countInBars = 2;
            }
            if (app == 0) draw();
        }

        function decreaseBar() {
            bar--;
            if (bar < 0) bar += numBars;
            measure = score[bar];
            updateMeasure();
            if (running == 0 && measure.type == 0) {
                countIn = 1;
                countInBars = 2;
            }
            if (app == 0) draw();
        }

        function selectALabel() {
            var sel = document.getElementById("select");
            bar = Number(sel.options[sel.selectedIndex].value) - 1;
            measure = score[bar];
            updateMeasure();
            if (app == 0) draw();
        }

        function selectAScore() {
            var sel = document.getElementById("choose");
            var name = sel.options[sel.selectedIndex].value;
            loadScore(name);
        }

        function updateMeasure() {
            beat = 0;
            elapsed = 0.0;
            numBeats = measure.numerator;
            angle = -1.5707963267949;
            if (measure.type == 0) {
                angleIncr = (2 * Math.PI) / ((60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur * measure.numerator);
                interval = (60.0 / (measure.tempo * tempoScaler)) * measure.beat_dur;
            }
            else {
                angleIncr = (2 * Math.PI) / (measure.beat_dur / tempoScaler);
                interval = measure.beat_dur / tempoScaler;
            }
            document.getElementById("display").innerHTML = JSON.stringify(measure);
        }

        /*
        function useSound()
        {
        var sel = document.getElementById("clicker");
        var test = Number(sel.options[sel.selectedIndex].value);
        switch(test)
        {
        case 0:
        click = 0;
        break;
        case 1:
        click = 1;
        subdiv = 0;
        break;
        case 2:
        click = 1;
        subdiv = 1;
        break;
        }
        playSound(1);
        }
        */
        function useSound() {
            if (click == 0) {
                click = 1;
                document.getElementById("clicker").innerHTML = "Click Off";
            }
            else {
                click = 0;
                document.getElementById("clicker").innerHTML = "Click On";
            }
            playSound(1);
        }

        function setLoop() {
            if (loop == 0) {
                loop = 1;
                document.getElementById("looper").innerHTML = "Loop Off";
            }
            else {
                loop = 0;
                document.getElementById("looper").innerHTML = "Loop On";
            }
            if (app == 0) draw();
        }

        function setLoopIn() {
            loopIn = bar;
        }

        function setLoopOut() {
            loopOut = bar;
        }

        function runApp() {
            if (app == 0) {
                app = 1;
                timer = setInterval(update, 10);
                document.getElementById("app").innerHTML = "Off";
            }
            else {
                app = 0;
                clearInterval(timer);
                document.getElementById("app").innerHTML = "On";
            }
//playSound(1);
        }

    </script>
</head>
<body id="main" onload="init()">

<div style="width:100%;padding-top:10px;padding-bottom:10px;">
    <div style="width:75%;margin-left:auto;margin-right:auto;">
        <canvas id="myCanvas" style="border:1px solid #000000;">
            canvas not supported!
        </canvas>
        <br/>
        <button id="app" type="button" onclick="runApp()">On</button>&nbsp;&nbsp;&nbsp;&nbsp;

        <button type="button" onclick="decreaseBar()"><<</button>
        <button id="run" type="button" onclick="start()">></button>
        <button id="kill" type="button" onclick="stop()">[]</button>
        <button type="button" onclick="increaseBar()">>></button>&nbsp;&nbsp;&nbsp;&nbsp;
        <button type="button" onclick="decreaseTempo()"><</button>
        Tempo
        <button type="button" onclick="increaseTempo()">></button>&nbsp;&nbsp;&nbsp;&nbsp;

        Rehearsal:
        <select id="select" onchange="selectALabel()">
        </select>&nbsp;&nbsp;&nbsp;&nbsp;
        <button type="button" onclick="setLoopIn()">In</button>
        <-
        <button id="looper" type="button" onclick="setLoop()">Loop On</button>
        ->
        <button type="button" onclick="setLoopOut()">Out</button>&nbsp;&nbsp;&nbsp;&nbsp;

        <!--
        <select id="clicker" onchange="useSound()">
        <option value="0">No Click</option>
        <option value="1">Click</option>
        <option value="2">Subdivide</option>
        </select>&nbsp;&nbsp;&nbsp;&nbsp;
        -->
        <button id="clicker" type="button" onclick="useSound()">Click On</button>&nbsp;&nbsp;&nbsp;&nbsp;

        <select id="choose" onchange="selectAScore()">
            <option value="defaultScore">Example Score</option>
            <option value="mandalas">Mandalas</option>
            <option value="askance">Askance</option>
            <option value="mandala5">Mandala 5</option>
            <option value="theRock">The Rock</option>
            <option value="andriessen">After Andriessen</option>
            <option value="skips">Skips</option>
        </select>&nbsp;&nbsp;&nbsp;&nbsp;
        <p id="display"></p>

    </div>
</div>
</body>
</html>
